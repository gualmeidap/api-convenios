<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs de Auditoria do Sistema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        /* Estilos de Ação */
        .log-CREATE { background-color: #d1fae5; color: #059669; } /* Verde - Criação */
        .log-UPDATE { background-color: #e0f2fe; color: #0069e0; } /* Azul - Atualização */
        .log-DELETE { background-color: #fee2e2; color: #ef4444; } /* Vermelho - Exclusão */
        .log-LOGIN { background-color: #fffbeb; color: #d97706; } /* Amarelo - Login */
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-screen-xl mx-auto bg-white rounded-3xl shadow-2xl p-6 md:p-10">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-8 text-center">Logs de Auditoria do Sistema</h1>
        <p class="text-gray-600 mb-6 text-center">Este painel exibe um histórico completo de todas as ações importantes realizadas por usuários administradores no sistema.</p>

        <!-- Filtros -->
        <div class="mb-8 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50 p-4 rounded-xl shadow-inner">
            <input type="text" id="searchInput" placeholder="Pesquisar (Usuário, Tabela, Detalhe...)" 
                   class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
            
            <select id="actionFilter" class="w-full md:w-1/4 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Filtrar por Ação</option>
                <option value="CREATE">CREATE</option>
                <option value="UPDATE">UPDATE</option>
                <option value="DELETE">DELETE</option>
                <option value="LOGIN">LOGIN (Se aplicável)</option>
            </select>
        </div>

        <!-- Tabela de Logs -->
        <div class="overflow-x-auto rounded-xl border border-gray-100">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-600 text-white">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider rounded-tl-xl">Data/Hora</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Usuário</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider">Ação</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Tabela</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">ID do Registro</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider rounded-tr-xl">Detalhes</th>
                    </tr>
                </thead>
                <tbody id="auditLogTableBody" class="bg-white divide-y divide-gray-100">
                    <!-- Logs serão injetados aqui -->
                </tbody>
            </table>
        </div>
        
        <p id="loadingMessage" class="mt-4 text-center text-gray-500">Carregando logs de auditoria...</p>
        <p id="noResults" class="mt-4 text-center text-gray-500 hidden">Nenhum log encontrado com os critérios de busca.</p>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('auditLogTableBody');
            const searchInput = document.getElementById('searchInput');
            const actionFilter = document.getElementById('actionFilter');
            const loadingMessage = document.getElementById('loadingMessage');
            const noResults = document.getElementById('noResults');

            let allLogs = [];

            // Função para buscar os logs do backend
            async function fetchAuditLogs() {
                loadingMessage.classList.remove('hidden');
                tableBody.innerHTML = '';
                
                try {
                    const response = await fetch('/logs_auditoria');
                    if (!response.ok) {
                        throw new Error('Falha ao carregar os logs de auditoria.');
                    }
                    allLogs = await response.json();
                    filterAndRenderTable();
                } catch (error) {
                    console.error('Erro ao buscar logs:', error);
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-sm text-center text-red-500">Erro ao carregar logs. Verifique a API.</td></tr>`;
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            }

            // Função para formatar o timestamp
            function formatTimestamp(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // Função para renderizar a tabela
            function renderTable(data) {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    noResults.classList.remove('hidden');
                    return;
                }
                noResults.classList.add('hidden');

                data.forEach(log => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');
                    const actionClass = 'log-' + log.action; // Classes definidas no <style>

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-900 font-mono">${formatTimestamp(log.timestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${log.username || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${actionClass}">${log.action}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${log.table_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${log.record_id}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${log.details}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Função para filtrar e renderizar
            function filterAndRenderTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedAction = actionFilter.value;
                
                const filtered = allLogs.filter(log => {
                    // 1. Filtro por Ação
                    const actionMatch = !selectedAction || log.action === selectedAction;
                    
                    // 2. Filtro por Busca (Usuário, Tabela, Detalhes)
                    const searchMatch = (
                        (log.username && log.username.toLowerCase().includes(searchTerm)) ||
                        (log.table_name && log.table_name.toLowerCase().includes(searchTerm)) ||
                        (log.details && log.details.toLowerCase().includes(searchTerm))
                    );
                    
                    return actionMatch && searchMatch;
                });
                
                renderTable(filtered);
            }

            // Eventos de Filtro e Busca
            searchInput.addEventListener('input', filterAndRenderTable);
            actionFilter.addEventListener('change', filterAndRenderTable);

            // Inicia o carregamento dos logs
            fetchAuditLogs();
        });
    </script>
</body>
</html>
