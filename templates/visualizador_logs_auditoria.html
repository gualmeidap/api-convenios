<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs de Auditoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 90%;
        }
        .table-responsive {
            overflow-x: auto;
        }
        th, td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="container mx-auto p-6 bg-white rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Logs de Auditoria</h1>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center items-center p-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <span class="ml-4 text-gray-500">Carregando logs...</span>
        </div>

        <!-- Table Container -->
        <div class="table-responsive">
            <table class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm">
                <thead>
                    <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs">
                        <th class="py-3 px-4 font-semibold">Usuário</th>
                        <th class="py-3 px-4 font-semibold">Ação</th>
                        <th class="py-3 px-4 font-semibold">ID do Registro</th>
                        <th class="py-3 px-4 font-semibold">Detalhes</th>
                        <th class="py-3 px-4 font-semibold">Data/Hora</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body" class="divide-y divide-gray-200 text-sm">
                    <!-- Logs will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.getElementById('logs-table-body');
            const loadingIndicator = document.getElementById('loading-indicator');

            try {
                // Fetch data from the new audit log API endpoint
                const response = await fetch('/logs_auditoria');
                if (!response.ok) {
                    throw new Error(`Erro ao buscar os logs: ${response.statusText}`);
                }
                const logs = await response.json();

                loadingIndicator.style.display = 'none';

                if (logs.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Nenhum log de auditoria encontrado.</td></tr>`;
                    return;
                }

                logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    // Parse and format the timestamp
                    const timestamp = new Date(log.timestamp).toLocaleString('pt-BR', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });

                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-700 font-semibold">${log.username}</td>
                        <td class="py-3 px-4 font-semibold ${log.action === 'DELETE' ? 'text-red-600' : log.action === 'CREATE' ? 'text-green-600' : 'text-blue-600'}">${log.action}</td>
                        <td class="py-3 px-4 text-gray-500 font-mono text-xs break-all">${log.record_id}</td>
                        <td class="py-3 px-4 text-gray-700">${log.details}</td>
                        <td class="py-3 px-4 text-gray-500">${timestamp}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error("Falha ao carregar logs:", error);
                loadingIndicator.style.display = 'none';
                tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-red-500">Erro ao carregar os dados. Verifique o console para mais detalhes.</td></tr>`;
            }
        });
    </script>
</body>
</html>
